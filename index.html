<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>My Docs</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome.min.css" rel="stylesheet">
        <link href="css/brands.min.css" rel="stylesheet">
        <link href="css/solid.min.css" rel="stylesheet">
        <link href="css/v4-font-face.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body class="homepage">
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href=".">My Docs</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#practica-2-4-balanceo-de-carga" class="nav-link">Práctica 2-4. Balanceo de carga</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#configuracion-del-primer-servidor-web" class="nav-link">Configuración del primer servidor web</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#configuracion-del-segundo-servidor-web" class="nav-link">Configuración del segundo servidor web</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#configuracion-del-servidor-proxy-inverso" class="nav-link">Configuración del servidor proxy inverso</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#apunte-sobre-solucion-de-problemas" class="nav-link">Apunte sobre solución de problemas</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#cuestiones-finales" class="nav-link">Cuestiones finales</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="practica-2-4-balanceo-de-carga">Práctica 2-4. Balanceo de carga</h1>
<p>Para realizar esta tarea es necesario clonar la MV que funciona como servidor web. 
De esta manera, tendremos dos servidores web y un servidor que funciona como proxy 
inverso y balanceador de carga.</p>
<p>Un recordatorio de las IPs que se están utilizando en cada máquina: </p>
<ul>
    <li><b>Anfitriona:</b> 192.168.0.13</li>
    <li><b>Servidor web 1:</b> 192.168.0.20</li>
    <li><b>Servidor web 2:</b> 192.168.0.21</li>
    <li><b>Servidor proxy:</b> 192.168.0.22</li>
</ul>

<h2 id="configuracion-del-primer-servidor-web">Configuración del primer servidor web</h2>
<p>Será necesario cambiar el nombre del directorio que contiene los archivos 
del servidor web a webserver1. Lo mismo con el archivo de configuración y 
con el enlace simbólico, en los directorios /etc/nginx/sites-available y 
/etc/nginx/sites-enabled.</p>
<p>Además, se le añade una cabecera al archivo de configuración. En mi caso:</p>
<pre><code class="language-console">location /{
    add-header Serv_Web1_PerezBernabeuAlberto &quot;Servidor Web 1&quot;;
}
</code></pre>
<p>También he modificado el contenido del HTML del servidor, para que muestre:</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt; Prueba de balanceo con NGINX&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h2&gt;Este es el servidor web 1&lt;/h2&gt;
    &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="configuracion-del-segundo-servidor-web">Configuración del segundo servidor web</h2>
<p>La configuración del segundo servidor es la misma que la del primer servidor web, 
cambiando "webserver1" por "webserver2" en los lugares que es necesario.</p>
<h2 id="configuracion-del-servidor-proxy-inverso">Configuración del servidor proxy inverso</h2>
<p>En el servidor proxy inverso, para configurar el balanceo de carga, 
modificamos el archivo de configuración de /etc/nginx/sites-available/ de 
la siguiente manera: </p>
<pre><code class="language-console">upstream backend_hosts {
    random;
    server 192.168.0.20:8080;
    server 192.168.0.21:8080;
}

server {
    listen 80;
    listen [::]:80;
    server_name webserver www.webserver.com;
    location / {
        proxy_pass http://backend_hosts;
        # add_header Host proxy_inverso_albertoperez;
    }
}
</code></pre>
<p>Así, cuando desde la máquina anfitriona busquemos 192.168.0.22:80 (o la IP correspondiente al servidor 
o el nombre que le hayamos dado desde el archivo /etc/hosts de la anfitriona) recibiremos realmente 
el contenido de uno de los servidores web, en este caso, aleatoriamente.</p>
<p><img alt="Recibido contenido de webserver1" src="images/webserver1.png" /></p>
<p><img alt="Recibido contenido de webserver2" src="images/webserver2.png" /></p>
<p>Podemos observar que en ambos casos, efectivamente, se ha buscado la IP del servidor proxy, pero en un 
caso se ha devuelto el contenido del servidor web 1 y su cabecera correspondiente y en el otro caso se 
ha devuelto el contenido del servidor web 2 y su cabecera correspondiente.</p>
<p>Si paramos el servicio de Nginx en uno de los servidores web, sólo se mostrará el contenido del otro 
servidor. Lo mismo ocurrirá si por una causa ajena uno de los servidores web cae o es inutilizado.</p>
<h2 id="apunte-sobre-solucion-de-problemas">Apunte sobre solución de problemas</h2>
<p>Al trabajar con varias máquinas al mismo tiempo, hay que tener en cuenta que existen muchos errores que 
pueden ocurrir y es necesario saber cómo diagnosticar qué está fallando cuando no obtememos el resultado 
que esperamos. </p>
<p>En mi caso, a mitad de realizar esta práctica, tenía configurados correctamente los servidores web y el servidor proxy, pero al acceder a la IP de 
éste desde el navegador de mi máquina anfitriona, no accedía al contenido. La manera de proceder para 
diagnosticar el problema fue el siguiente:</p>
<ol>
    <li>
        <b>Comprobar que existe comunicación entre los servidores web y el proxy inverso</b><br>
        Para ello, podemos utilizar <b>curl</b> y <b>ping</b> desde el proxy:

<pre><code class="language-console">curl 192.168.0.20:8080
curl 192.168.0.21:8080

ping 192.168.0.20
ping 192.168.0.21
</code></pre>

        En mi caso particular, con ping comprobé que existía comunicación entre las máquinas, pero curl no devolvía 
        correctamente el servicio alojado en los puertos de los servidores web.
    </li><br>
    <li>
        <b>Comprobar que existe una regla de cortafuegos para los puertos :8080 en los servidores web</b><br>
        Para ello, podemos utilizar la herramienta <b>ufw</b>:

<pre><code class="language-console">sudo ufw status         # Muestra las reglas existentes
sudo ufw allow 8080/tcp     # Crear la regla si no existe para que se permita la comunicación por el puerto :8080
</code></pre>

        En mi caso no existía la regla para permitir la comunicación por los puertos :8080 de los servidores web. Una vez 
        creadas las reglas en cada servidor web, pude terminar la práctica correctamente.
    </li><br>
    <li>
        <b>Comprobar las configuraciones de cada servidor</b><br>
        Una vez hechas las comprobaciones pertinentes sobre las conexiones de los servidores, si existe algún problema, 
        es bastante probable que estos se encuentren en los archivos de configuración de /etc/nginx/sites-available de 
        alguno de los servidores. Podemos obtener indicaciones valiosas desde Nginx ejecutando:

<pre><code class="language-console">sudo nginx -t
</code></pre>

</ol>

<h2 id="cuestiones-finales">Cuestiones finales</h2>
<p><b>1. Busca información de qué otros métodos de balanceo se pueden aplicar con Nginx y describe al menos 3 de ellos.</b></p>
<p>Otros métodos de balanceo que permite Nginx son: </p>
<ul>
<li>
<p><b>least_conn:</b> el proxy enviará las solicitudes entrantes al servidor que tenga un menor número de conexiones activas en 
ese momento, para evitar las eventuales sobrecargas.</p>
</li>
<li>
<p><b>ip_hash:</b> se asigna cada solicitud a un servidor en función del hash de la dirección del cliente, de manera que todas 
las solicitudes de un mismo cliente serán dirigidas siempre al mismo servidor. En caso de que caiga el servidor, se enviará la 
petición al siguiente servidor en el grupo.</p>
</li>
<li>
<p><b>least_time:</b> la petición será enviada al servidor con menor latencia y menor cantidad de conexiones activas, es decir, 
el que ofrezca un menor tiempo de espera para la respuesta.</p>
</li>
</ul>
<p><b>2. Si quiero añadir 2 servidores web más al balanceo de carga, describe detalladamente qué configuración habría que añadir y dónde.</b></p>
<p>Considerando que tuvieramos dos nuevos servidores con configuraciones correctas (contenido correcto y con permisos adecuados en /var/www, 
archivos de configuración en /etc/nginx/sites-available correctos y Nginx funcionando correctamente y sin problemas con los permisos del 
cortafuegos), sólo sería necesario indicar las IPs y puertos de los servidores en el archivo de configuración del proxy. Por ejemplo:</p>
<pre><code class="language-console">upstream backend_hosts {
    server 192.168.0.20:8080;
    server 192.168.0.21:8080;   
    server 192.168.0.23:8080;   # Nuevo servidor
    server 192.168.0.24:8080;   # Nuevo servidor
}
</code></pre>
<p>En caso de error, sería necesario realizar las comprobaciones oportunas en los nuevos servidores web (que Nginx funcione correctamente en ellos 
y que exista conexión estable entre estos y el proxy)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js"></script>
        <script src="search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2024-11-03 16:18:20.895094+00:00
-->
